# Forgot Password Feature - Setup Documentation

## Overview

The Glyzier platform now includes a complete **forgot password** functionality with email-based verification codes. Users can reset their passwords using a 6-digit code sent to their registered email address.

---

## Implementation Summary

### Backend (Spring Boot)

#### 1. **Dependencies Added** (`pom.xml`)
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>
```

#### 2. **Email Configuration**

**Main Properties File** (`application.properties`):
```properties
# Email Configuration (Template - Override in application-supabase.properties)
spring.mail.host=smtp.gmail.com
spring.mail.port=587
spring.mail.username=${EMAIL_USERNAME:your-email@gmail.com}
spring.mail.password=${EMAIL_PASSWORD:your-app-password}
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.properties.mail.smtp.starttls.required=true
spring.mail.from=${EMAIL_FROM:your-email@gmail.com}
```

**Supabase Properties File** (`application-supabase.properties` - **NOT in git**):
```properties
# Email Configuration (Gmail SMTP)
spring.mail.username=YOUR_EMAIL@gmail.com
spring.mail.password=YOUR_APP_PASSWORD
spring.mail.from=YOUR_EMAIL@gmail.com
```

**Note:** Actual email credentials are stored in `application-supabase.properties` which is gitignored for security.

#### 3. **Database Model** (`PasswordResetCode.java`)
- **Table:** `password_reset_codes`
- **Fields:**
  - `id` (Primary Key)
  - `email` (User's email)
  - `code` (6-digit verification code)
  - `created_at` (Timestamp)
  - `expires_at` (10 minutes from creation)
  - `used` (Boolean - marks if code has been used)

**Auto-generated by Hibernate** when the application starts (ddl-auto=update).

#### 4. **Repository** (`PasswordResetCodeRepository.java`)
Queries:
- Find valid unused code by email and code
- Find latest valid code for email
- Invalidate all unused codes for email

#### 5. **Service Layer** (`PasswordResetService.java`)
Two main operations:
- **`sendResetCode(email)`**: Generates 6-digit code, saves to DB, sends email
- **`resetPassword(email, code, newPassword)`**: Validates code and updates password

#### 6. **Controller Endpoints** (`AuthController.java`)
Two new public endpoints:

**POST /api/auth/forgot-password**
```json
Request:
{
  "email": "user@example.com"
}

Response (200 OK):
{
  "message": "Password reset code sent to user@example.com"
}

Error (400 Bad Request):
{
  "error": "Email not found"
}
```

**POST /api/auth/reset-password**
```json
Request:
{
  "email": "user@example.com",
  "code": "123456",
  "newPassword": "newSecurePassword"
}

Response (200 OK):
{
  "message": "Password reset successfully"
}

Error (400 Bad Request):
{
  "error": "Invalid or expired reset code"
}
```

#### 7. **Email Service** (`EmailService.java`)
- Sends password reset codes via Gmail SMTP
- Falls back to console logging if email fails
- Displays detailed configuration status on startup

---

### Frontend (React)

#### 1. **Auth Service** (`authService.js`)
Two new functions added:
- `forgotPassword(email)` - Request reset code
- `resetPassword(email, code, newPassword)` - Reset password

#### 2. **Pages Created**
- **ForgotPasswordPage** (`/forgot-password`) - Request reset code
- **ResetPasswordPage** (`/reset-password`) - Enter code and new password

#### 3. **Routes Added** (`App.jsx`)
```jsx
<Route path="/forgot-password" element={<ForgotPasswordPage />} />
<Route path="/reset-password" element={<ResetPasswordPage />} />
```

#### 4. **Login Page Updated** (`LoginPage.jsx`)
Added "Forgot password?" link below the password field, next to "Keep me signed in" checkbox.

---

## User Flow

### Step 1: Request Password Reset
1. User clicks "Forgot password?" on login page
2. Navigates to `/forgot-password`
3. Enters email address
4. Clicks "Send Reset Code"
5. Backend generates 6-digit code, saves to DB, sends email
6. User sees success message
7. Redirected to `/reset-password?email=user@example.com`

### Step 2: Reset Password
1. User receives email with 6-digit code (valid for 10 minutes)
2. On reset password page, enters:
   - 6-digit code
   - New password
   - Confirm password
3. Clicks "Reset Password"
4. Backend validates code and updates password
5. Success popup shows "Password Changed Successfully!"
6. Auto-redirected to login page after 5 seconds

---

## Security Features

### Code Generation
- **6-digit random code** (100000-999999)
- **10-minute expiration** time
- **One-time use** - marked as used after successful reset

### Code Management
- **Latest code priority** - Only the most recent code is valid
- **Automatic invalidation** - All previous unused codes invalidated when new code generated
- **Secure validation** - Code must match exactly and not be expired

### Password Requirements
- **Minimum 6 characters** (enforced on both frontend and backend)
- **BCrypt encryption** before storage
- **All old codes invalidated** after successful password reset

---

## Email Configuration

### Gmail App Password Setup
The email is configured to use **Gmail SMTP** with an app-specific password:

1. **SMTP Host**: smtp.gmail.com
2. **Port**: 587 (TLS)
3. **Credentials**: Stored in `application-supabase.properties` (gitignored)

### Setting Up Your Email

1. **Generate Gmail App Password**:
   - Go to https://myaccount.google.com/apppasswords
   - Enable 2-Step Verification if not already enabled
   - Generate an app password for "Mail"
   - Copy the 16-character password (spaces removed)

2. **Configure in application-supabase.properties**:
   ```properties
   spring.mail.username=your-email@gmail.com
   spring.mail.password=your-16-char-app-password
   spring.mail.from=your-email@gmail.com
   ```

### Email Template
```
Subject: Glyzier - Password Reset Code

Your password reset code is: 123456

This code will expire in 10 minutes.

If you did not request this code, please ignore this email.

Best regards,
Glyzier Team
```

### Troubleshooting Email Issues
If emails don't send:
1. **Check console logs** - The code is ALWAYS logged to the terminal for development
2. **Verify Gmail settings** - 2-Step Verification must be enabled
3. **Check app password** - Must be valid and not revoked
4. **Network issues** - Ensure server can reach smtp.gmail.com:587

---

## Testing the Feature

### Manual Testing Steps

#### Test 1: Valid Email Reset Flow

**Prerequisites**: Configure email in `application-supabase.properties` first!

1. Start backend: `cd glyzier-backend && ./mvnw spring-boot:run`
2. Start frontend: `cd glyzier-frontend && npm run dev`
3. Navigate to `http://localhost:5173/forgot-password`
4. Enter a registered email (e.g., your test user email)
5. Check terminal logs for the 6-digit code (always logged)
6. Check email inbox for the code (if email is configured)
7. Enter code on reset password page
8. Set new password and submit
9. Login with new password

#### Test 2: Invalid Email
1. Enter non-existent email
2. Should see error: "Email not found"

#### Test 3: Expired Code
1. Request reset code
2. Wait 11 minutes
3. Try to use code
4. Should see error: "Invalid or expired reset code"

#### Test 4: Invalid Code
1. Request reset code
2. Enter wrong code (e.g., 999999)
3. Should see error: "Invalid reset code"

#### Test 5: Password Validation
1. Request reset code
2. Enter valid code
3. Try passwords less than 6 characters
4. Should see error: "Password must be at least 6 characters"

### API Testing with cURL

#### Request Reset Code
```bash
curl -X POST http://localhost:8080/api/auth/forgot-password \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com"}'
```

Expected: `{"message":"Password reset code sent to user@example.com"}`

#### Reset Password
```bash
curl -X POST http://localhost:8080/api/auth/reset-password \
  -H "Content-Type: application/json" \
  -d '{
    "email":"user@example.com",
    "code":"123456",
    "newPassword":"newPassword123"
  }'
```

Expected: `{"message":"Password reset successfully"}`

---

## Production Deployment Notes

### Email Credentials

**Current Setup** (Development):
- Credentials stored in `application-supabase.properties` (gitignored)
- This file is NOT committed to version control
- Each developer maintains their own copy locally

**Production Deployment**:
1. Use **environment variables** instead of property files:
   ```bash
   export EMAIL_USERNAME=your-email@gmail.com
   export EMAIL_PASSWORD=your-app-password
   export EMAIL_FROM=your-email@gmail.com
   ```

2. Or set in your deployment platform (Render, Heroku, AWS, etc.):
   ```properties
   spring.mail.username=${EMAIL_USERNAME}
   spring.mail.password=${EMAIL_PASSWORD}
   spring.mail.from=${EMAIL_FROM}
   ```

3. Consider using a dedicated email service:
   - SendGrid (99% deliverability, 100 emails/day free)
   - AWS SES (High volume, pay-as-you-go)
   - Mailgun (Developer-friendly API)

4. Set up proper SPF/DKIM records for better deliverability

### Rate Limiting (Recommended)
Consider adding:
- **Cooldown period** between reset requests (e.g., 1 minute)
- **Max attempts per email** per day (e.g., 5 attempts)
- **IP-based rate limiting** to prevent abuse

### Monitoring
Monitor:
- Email delivery success/failure rates
- Reset code generation frequency
- Failed reset attempts

---

## Database Schema

The `password_reset_codes` table is **automatically created** by Hibernate with this structure:

```sql
CREATE TABLE password_reset_codes (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    code VARCHAR(6) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    used BOOLEAN NOT NULL DEFAULT false
);
```

---

## Code Structure

```
glyzier-backend/
├── src/main/java/com/glyzier/
│   ├── controller/
│   │   └── AuthController.java (Added forgot/reset endpoints)
│   ├── service/
│   │   ├── PasswordResetService.java (NEW)
│   │   └── EmailService.java (Existing, sends emails)
│   ├── repository/
│   │   └── PasswordResetCodeRepository.java (NEW)
│   ├── model/
│   │   └── PasswordResetCode.java (NEW)
│   └── dto/
│       ├── ForgotPasswordRequest.java (NEW)
│       └── ResetPasswordRequest.java (NEW)
└── src/main/resources/
    └── application.properties (Updated with email config)

glyzier-frontend/
├── src/
│   ├── pages/
│   │   ├── ForgotPasswordPage.jsx (NEW)
│   │   ├── ResetPasswordPage.jsx (NEW)
│   │   └── LoginPage.jsx (Updated with forgot link)
│   ├── services/
│   │   └── authService.js (Added forgot/reset functions)
│   └── styles/pages/
│       ├── ForgotPasswordPage.module.css (NEW)
│       ├── ResetPasswordPage.module.css (NEW)
│       └── LoginPage.module.css (Updated)
└── App.jsx (Added routes)
```

---

## Next Steps

### After Building
1. **Build backend**: `cd glyzier-backend && ./mvnw clean package`
2. **Run application**: `./mvnw spring-boot:run`
3. **Test endpoints** with real users
4. **Monitor email logs** for delivery issues

### Optional Enhancements
- Add email templates with HTML styling
- Implement SMS-based reset codes as alternative
- Add "Remember this device" functionality
- Track reset attempts for security monitoring

---

## Support

For issues related to:
- **Email delivery**: Check Gmail app password and 2-Step Verification
- **Database errors**: Ensure PostgreSQL is running and accessible
- **Frontend issues**: Clear browser cache and check console logs
- **Backend errors**: Check terminal logs for detailed stack traces

---

**Author**: Glyzier Team  
**Date**: December 3, 2025  
**Module**: Forgot Password Feature  
**Version**: 1.0
